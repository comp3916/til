Working on a project that requires validating JWT Claims at the APIM. Some notes below for future reference


![image](https://github.com/user-attachments/assets/cc8e7ce4-d84f-4cdf-8bb1-da346b4e8e61)

![image](https://github.com/user-attachments/assets/8b7278fe-cfdf-44df-b925-f86ad5cf5dd5)

![image](https://github.com/user-attachments/assets/ef754fbb-e30a-4deb-991f-08496d0d4d1c)

If you need to provide the key in the JWT policy, but this is unnecessary if the correct openid-configuration endpoint is provided, as this would be automatically done by the policy
![image](https://github.com/user-attachments/assets/77b2b407-3645-4853-a450-506f01eec707)


It is required to base64 encode the signing key (Info from SO - capturing for easy future access here)

![image](https://github.com/user-attachments/assets/6599a8b6-43da-4db8-9fec-b0f8a2a26f48)


![image](https://github.com/user-attachments/assets/6f390e26-cbb5-4f50-b652-cb14ce0420d9)

![image](https://github.com/user-attachments/assets/03489c11-89ee-4fc2-b8d1-f3d648c772d7)

Here is the link to the tool used in the above screenshot
[Test JWT Generator](http://jwtbuilder.jamiekurtz.com/)

Supporting multiple Identity providers
```
<set-variable 
   name="iss" 
   value="@(context.Request.Headers.GetValueOrDefault("Authorization", "")?.Split(' ')?.ElementAtOrDefault(1)?.AsJwt()?.Claims["iss"]?.FirstOrDefault() ?? "")" 
/>
<choose>
    <when condition="@(context.Variables.GetValueOrDefault("iss", "").Equals("myIssuer.com"))">
       <validate-jwt configuration1... />
    </when>
    <otherwise>
       <validate-jwt configuration2... />
    </otherwise>
</choose>
```

Another approach is to leverage different headers to qualify the target IDP

```
<choose>
    <when condition="@(context.Request.Headers.GetValueOrDefault("X-ProductCode","") == "XYZ")">
        <validate-jwt header-name="Authorization" failed-validation-httpcode="401" failed-validation-error-message="Unauthorized" require-expiration-time="true" require-signed-tokens="true">
            <openid-config url="https://xyz.au.auth0.com/.well-known/openid-configuration" />
            <audiences>
                <audience>xyz-audience1</audience>
            </audiences>
        </validate-jwt>
    </when>
    <when condition="@(context.Request.Headers.GetValueOrDefault("X-ProductCode","") == "ABC")">
        <validate-jwt header-name="Authorization" failed-validation-httpcode="401" failed-validation-error-message="Unauthorized" require-expiration-time="true" require-signed-tokens="true">
            <openid-config url="https://abc.au.auth0.com/.well-known/openid-configuration" />
            <audiences>
                <audience>abc-audience1</audience>
                <audience>abc-audience2</audience>
            </audiences>
        </validate-jwt>
    </when>
</choose>
```






